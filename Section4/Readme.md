# 네트워킹: (교차) 컨테이너 통신
# case 1: WWW 통신 컨테이너
컨테이너에 속한 어플리케이션에서 웹 상으로 API 를 전송하고 받는 것이다.     
컨테이너 내부에서 컨테이너 외부로 HTTP 요청이 전송될 수 있다.

이것이 도커화된 앱에서 가능한 한가지 통신 방법이다.
HTTP 요청을 다른 웹사이트나 웹 API 로 전송하는 방법이다.

# case2: 컨테이너에서 로컬 호스트 머신으로의 통신
HTTP 통신이 단순히 도커화된 앱에서 할 수 있는 유일한 통신 방식은 아니다.
우리는 호스팅 머신이나 데이터베이스와 같은 것을 보유하고 있을 수도 있다. 도커화된 앱 내부에서 그것들과 통신하고자 할 수 있다.

# case3: 컨테이너 간 통신
컨테이너 내부에서 실행 중인 어플리케이션이 다른 컨테이너와 통신할 수 있다.
중간 컨테이너에 있는 어플리케이션이 다른 컨테이너에 있는 이 SQL 데티어베이스와 통신하기를 원하는 경우이다.
보통 다중 컨테이너로 어플리케이션을 구축하는 것은 매우 일반적이다.

도커를 사용하면 각각 컨테이너가 한 가지 주요 작업만 수행하는 것이 권장되는 모범 사례이다.
예를 들면 노드 어플리케이션이 하나의 컨테이너와 하나의 이미지로 실행되고, Mongo DB 가 다른 이미지를 사용하여 다른 컨테이너에서 실행되는 것이다.

# 컨테이너 만들기 & 웹 통신하기(WWW)
- 엔드포인트: 요청을 받아 응답을 제공하는 서비스를 사용할 수 있는 지점

우선 어플리케이션의 Dockerfile 을 빌드해야 한다. 이름과 태그를 추가할 수 있다.
```
$ docker built -t [이름]:[태그] .
```

빌드된 이미지를 기반으로 컨테이너를 실행시킨다.
```
$ docker run ...
```

컨테이너가 로컬에 있는 데이터베이스, 즉 호스트 머신에 연결해야 한다면 실패하게 된다.  
하지만 기본적으로 컨테이너는 월드 와이드 웹에 요청을 보낼 수 있다. 별도의 설정이 필요 없이 도커화된 어플리케이션에서 웹 API 및 웹 페이지와는 통신할 수 있다.

# 호스트 통신 작업을 위한 컨테이너 만들기
기본적으로 로컬과 컨테이너간에 통신을 할 수 없다. 
하지만 도커에게 로컬과 통신작업을 해야한다는 힌트를 주면 해결가능하다.
```host.docker.internal``` 이 특수한 도메인이 도커에 의해 로컬 호스트라는 인식이 된다. 그리고 도커 어플리케이션에서 알 수 있는 호스트 머신의 IP 주소로 변환된다.

```
mongodb://localhost:27017/TestDB -> mongodb://host.docker.internal:27017/TestDB 
```

도메인이나 URL 이 필요한 곳 어디서나 사용이 가능하다. 특수 도메인으로 설정해놓으면 나머지는 도커가 알아서 처리한다.

# 컨테이너 간 통신: 기본 솔루션
모든 컨테이너는 한 가지에 역할만 수행하여 집중하도록 설계하는 것이 좋다.
예를 들면 어플리케이션 컨테이너와 데이터베이스 컨테이너를 나누는 것이다.

<img width="1066" alt="스크린샷 2022-06-19 오후 11 18 52" src="https://user-images.githubusercontent.com/63203480/174485617-cd0effd1-906f-4870-ade6-771220b3538a.png">


mongodb 를 별도의 컨테이너에 실행시킨 뒤, ```$ docker container inspect [컨테이너명] ``` 명령으로 확인해보면 
NetworkSettings 에서 **IPAddress** 를 확인할 수 있다. 이것은 컨테이너의 IP 주소이다.
해당 IP 주소를 통해 데이터베이스 컨테이너에 연결할 수 있다.

```
mongodb://host.docker.internal:27017/TestDB -> mongodb://172.17.0.2:27017/TestDB 
```

이것은 로컬 호스트 머신의 MongoDB 가 아닌 Mongo 컨테이너에 있는 완전히 새로운 Mongo Database 를 사용하는 것이다.
완전히 별개의 격리된 데이터베이스이다. 결국 **분리와 격리**는 도커의 핵심 개념이자 도커를 사용하는 핵심적인 이유이다.

# Docker Networks: 우아한 컨테이너 간 통신
여러 개의 컨테이너가 있을 때, 이러한 컨테이너 간의 통신을 허용하는 것이다.
```docker run``` 명령에 ```--network``` 옵션을 추가하면 이러한 모든 컨테이너를 하나의 동일한 네트워크에 밀어넣을 수 있다.
즉, 모든 컨테이너가 서로 통신할 수 있는 네트워크가 생성된다. 이렇게 된다면 도커가 이전에 IP 조회 및 해결 작업을 자동으로 수행할 수 있게된다.    
고유한 임무와 작업을 가진 다수의 격리된 컨테이너를 갖게되는데, 아주 유용한 기능이다.

도커는 자동으로 네트워크를 생성하지 않는다. 따라서 ```$docker network create [네트워크명]``` 명령으로 네트워크를 생성해야 한다.   
그 후에 다른 복잡한 구성은 필요하지 않는다. 이것은 도커 컨테이너에서 컨테이너 서로 간에 통신을 하는데 사용할 수 있다.
두 개, 혹은 더 많은 컨테이너가 있더라도 동일한 네트워크의 일부가 되어 그들간의 통신이 가능하다.

두 개 이상의 컨테이너가 동일한 네트워크의 일부분인 경우 다른 컨테이너 이름을 어플리케이션 코드 상에 입력할 수 있다.
```
mongodb://172.17.0.2:27017/TestDB  -> mongodb://[컨테이너명]:27017/TestDB 
```

같은 네트워크를 사용하기 위해서는 컨테이너 실행 시 ```--network``` 옵션을 통해 같은 네트워크를 입력해줘야 한다.
```
$ docker run --network test-net --name app ...
$ docker run --network test-net --name database ...
```

일반적으로 컨테이너 실행 시 ```-p``` 옵션을 통해 포트를 노출하는 것은 로컬 호스트 머신이나 컨테이너 외부에서 컨테이너에 연결하려는 경우에만 필요하다.
