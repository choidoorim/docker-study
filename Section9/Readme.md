# 섹션 9: Docker 컨테이너 배포하기
# 개발(Development) 에서 제품 생산(Production) 까지
만약 컨테이너가 없다면 천차만별의 개발 및 프로덕션 환경을 모두 구축할 수 밖에 없다.   
즉, 리모트 호스트 서버에 어플리케이션을 배포하면 로컬 상에서 잘되던 코드가 갑자기 작동하지 않게 되는 것이다.
따라서 개발 환경을 동일하게 가져갈 수 있다는 큰 장점이 있다.     
컨테이너의 **"로컬 머신에서 작동하는 것은 리모트 머신에 배포한 후에도 작동한다"** 라는 것이 도커의 아이디어 배경 사상이다.

컨테이너를 로컬 머신에서 **최종 제품으로 만들 때는 바인드 마운트를 사용하면 안된다**.   
로컬에서 Docker Compose 를 사용하여 모든 것을 테스트할 수 있지만 배포를 위해 다중 서버 또는 다중 호스트 머신에 걸쳐 분할하는 것을 고려할 수 있다.

# 배포 프로세스 & 프로바이더
리모트 서버에 SSH 를 통해 연결하고, 어플리케이에서 개발한 도커 이미지를 도커 허브와 같은 도커 레지스트리로 푸시한 다음 리모트 서버에서 그 이미지를 가져온다.   
그런 다음, 리모트 호스트에 컨테이너를 실행하고 노출해야 하는 모든 포트를 World Wide Web 에 노출한다.

AWS, Azure, Google Cloud 3 가지의 유명한 호스팅 프로바이더가 있다. 

도커화 된 어플리케이션을 실행하기 위해서 준비해야 될 것이 있다.
1. Aws EC2 인스턴스를 생성해야 한다.
2. 필요한 모든 포트를 World Wide Web 에 노출하도록 보안 그룹을 구성해야 한다.
3. Secure Shell 을 의미하는 SSH 를 통해 인스턴스와 연결해야 한다.

# Production 에서 바인드 마운트
## Development 환경
Production 환경에서는 바인드 마운트를 사용하지 않는다.   
그 이유는 바로 개발 모드와 프로덕션 모드 사이에서 컨테이너를 실행하는 것에 차이가 있기 때문이다.    
어플리케이션 작업을 하는 동안에는 컨테이너, 런타임 환경 등을 캡슐화 해야되지만 **코드를 캡슐화 할 필요는 없다**.

개발 환경에서는 로컬의 프로젝트 폴더를 실행 중인 컨테이너 내부의 특정 폴더에 바인딩하여 최신 프로젝트 코드가 항상 컨테이너에 노출되었기에 
코드의 변경사항이 그 컨테이너의 재시작 없이도 즉시 반영될 수 있었다.
이러한 점은 개발 중에 매우 편리하기 때문에 개발 중에 일반적으로 수행하는 작업이다.
즉각적인 업데이트와 이미지를 리빌드하여 컨테이너를 재시작할 필요가 없기 때문이다.

## Production 환경
하지만 Production 환경에서는 이미지와 컨테이너를 취하여, 이를 실행하는 리모트 머신으로 이동한다.
컨테이너는 자립하여 작동하며 리모트 머신의 **주변 설정에 의존하지 않는다**는 것이 도커의 아이디어 사상이다.     
이미지와 그 이미지를 기반으로 하는 컨테이너는 단 하나의 소스이어야 한다고 할 수 있다. 
즉, 이미지를 가져와서 이를 기반으로 **컨테이너를 실행하면 어플리케이션에 필요한 모든 것을 얻을 수 있다는 것**이다.     
컨테이너 안에 우리가 필요한 모든 것들이 담겨져 있어야 한다.    

Production 환경에서는 바인딩 마운트 대신 복사본을 사용한다. 즉, 이미지를 빌드할 때 소스 코드를 이미지에 복사하므로
빌드된 이미지에는 소스 코드와 어플리케이션 환경이 존재한다.
```dockerfile
# ...
COPY . .
```
따라서 바인드 마운트 대신에 ```COPY``` 를 Production 환경에 사용하려는 것이다.

Dockerfile 에 바인드 마운트 설정을 하는 것이 아니라 ```$ docker run``` 명령 실행 시 설정했기 때문에 로컬에서는 바인드 마운트를 사용해도 상관없다.
그렇기에 Development 환경과 Production 환경에 동일한 Dockerfile 을 사용할 수 있다.    
이것이 항상 정확히 동일한 이미지로 작업하고 개발 중에 더 많은 유연성을 갖도록 보장할 수 있는 방법이다.

따라서 컨테이너를 **실행하는 위치에 관계없이 모든 이미지가 주변 설정, 구성이나 코드 없이 실행될 수 있음을 보장**한다.

# AWS & EC2 소개
AWS 를 통해 리모트 머신을 생성할 수 있다. 인스턴스는 사양에 따라 다양하게 선택하여 생성할 수 있다.     
인스턴스 생성 시 키 페어가 제공되는데, 만약 분실한 경우에는 인스턴스를 종료하고, 새 인스턴스를 시작해야 한다.   

그리고 로컬 머신으로 부터 리모트 머신에 연결하기 위한 SSH 프로토콜을 통해 연결한다. 
Mac OS 같은 경우에는 ssh 명령을 내장하기 때문에 SSH 연결을 설정하는데 사용하기 편한다.
```AWS EC2 -> 인스턴스 -> 인스턴스에 연결 -> SSH 클라이언트``` 명령으로 SSH 를 활용해 인스턴스에 연결할 수 있다.

완료된다면 리모트 머신에 도커를 설치하고 컨테이너를 실행시켜야 한다.   

# 가상 머신에 Docker 설치하기
- ```sudo```: root 사용자 권한으로 명령을 실행

리모트 머신에서 ```sudo yum update -y``` 명령을 실행하면 모든 필수 패키지가 업데이트 되고, 최신 버전을 사용하고 있는지 확인할 수 있다.   

그리고 ```sudo amazon-linux-extras install docker``` 명령을 통해 도커를 설치한다. AWS 기반 가상 인스턴스에서는 도커와 같은 부가 소프트웨어를
매우 쉽게 설치할 수 있는 이러한 명령을 사용할 수 있다.

설치가 완료되었다면 ```sudo service docker start``` 명령을 통해 Docker 를 실행할 수 있다.

# 로컬 이미지를 클라우드로 푸시(push) 하기
첫 번째 방법은 프로젝트 폴더의 모든 항목을 리모트 머신에 복사하는 방식이 있다. 그런 다음 거기에서 이미지를 구축한다.
리모트 머신에서 소스 코드를 내려 받고, ```$ docker build``` 명령으로 이미지를 만들고 ```$ docker run``` 으로 실행하는 것이다.   
이 방법은 불필요하고 복잡한 것이 많다.    

두 번째 방법은 로컬 머신에서 미리 이미지를 빌드하는 것이다. 그런 다음, 구축된 이미지를 리모트 머신에 배포하기만 하면 된다.    
로컬에 이미지가 생성되면 리모트 머신에서 ```$ docker run``` 을 실행하기만 하면 된다.
이미지를 로컬에서 빌드한 다음 그 이미지를 Docker Hub 에 푸시하고, 리모트 서버에서 그 이미지를 끌어온 다음 실행할 수 있다.

Docker Hub 에 Repository 를 만들고 로컬의 이미지를 저장한다.    
우선 ```$ docker tag``` 명령을 통해 기존 이미지의 이름을 변경하여 Docker Hub 에 푸시할 수 있다.  
예를 들면 이미지명이 ```node-test``` 이고, docker hub repo 명칭이 ```durumi/docker-test``` 라고 가정해보자.
그렇다면 ```$ docker tag node-test durumi/docker-test``` 명령을 실행하여 ```durumi/docker-test``` 를 새 이름으로 사용할 수 있다.

그리고 ```$ docker push durumi/docker-test``` 명령을 실행하여 도커 Repo 에 이미지를 푸시하면 된다.
만약 로그인이 되지 않아 명령이 실패할 경우 ```$ docker login``` 명령을 통해 도커 로그인을 해야 한다.

