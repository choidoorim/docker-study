# Section7: 유틸리티 컨테이너로 작업하기 & 컨테이너에서 명령 실행하기
# 유틸리티 컨테이너란 무엇인가?
유틸리티 컨테이너란 공식적인 용어는 아니다.    
기존에는 어플리케이션 컨테이너 작업을 했다. 그리고 그 도커 컨테이너는 어플리케이션 코드와 실행을 위한 환경이 포함되어 있다.
그리고 이것은 전형적인 도커의 구조이며 도커를 사용하는 이유이다.

유틸리티 컨테이너는 **특정 환경만 포함하는 컨테이너**를 의미한다. 즉, npm 명령을 실행할 수 있는 유틸리티 이미지이다.
이것은 환경(NodeJS, PHP 등...) 을 실행할 때 어플리케이션을 시작하지 않는다. 대신 특정 작업을 실행하기 위해 지정한 명령과 함께 실행한다.   
컨테이너를 시작할 때 이미지 이름 뒤에 부가 명령을 추가한다.

# 유틸리티 컨테이너: 왜 사용하는가?
예를 들면 시스템에 노드를 설치하지 않고도 어플리케이션을 만들 수 있다.      
노드 앱에 대한 일부 구성이 포함된 ```package.json``` 파일이 필요하다. 가장 중요한 것은 어플리케이션에 필요한 종속성 목록이 있어야 되는 것이다.

처음 프로젝트를 셋팅하기 위해서는 초기에 로컬 시스템에 해당 툴들이 설치되어 있어야 한다. 바로 이 부분을 유틸리티 컨테이너가 도와준다.

# 컨테이너에서 명령을 실행하는 다양한 방법
```$ docker exec``` 명령을 사용하면 컨테이너가 실행하는 기본 명령 외에 실행 중인 컨테이너 내에서 특정명령을 실행할 수 있다.
```exec``` 명령은 프로세스에 계속 연결되기 위해서는 인터렉티브 모드에서 시작되어야만 한다.     
이것은 통해 **실행 중인 컨테이너에서도 프로젝트를 설치할 수 있다**는 것을 알 수 있다.
메인 프로세스를 중단하지 않고 컨테이너 내부에 작성된 로그 파일을 읽는데 유용하다. 

컨테이너 실행 구문 마지막에 디폴트 명령을 오버라이드해서 넣을 수 있다. 
```
$ docker run -it node npm init
```

# 첫 번째 유틸리티 컨테이너 구축
유틸리티 컨테이너를 만들기 위해서는 자채 이미지가 필요하다. 이미지를 사용해서 컨테이너를 실행할 때 컨테이너 내부 경로와 현재 프로젝트 경로를 바인드 마운트로 설정하면
컨테이너 내부에서 실행하는 명령이 호스트 머신에도 공유된다. 
```
$ docker run -it -v [로컬경로:/컨테이너내부경로] [이미지명] [명령](ex. npm init)
```

# ENTRYPOINT 활용
```docker run``` 이미지 이름 뒤에 명령을 추가하게 되면 **Dockerfile 의 CMD 를 덮어쓴다**. 즉, Dockerfile 의 명령이 실행되지 않고 이미지 뒤의 명령이 실행된다는 것이다.
ENTRYPOINT 같은 경우에는 ```docker run``` 에서 이미지 이름 뒤에 여기에 입력하는 모든 것이 ENTRYPOINT 뒤에 추가된다.

```dockerfile
#...
ENTRYPOINT ["npm"]
```
ENTRYPOINT 설정 후에 명령을 실행하게 되면 npm 을 넣지 않아도 된다.
```
$ docker run -it -v [로컬경로:/컨테이너내부경로] [이미지명] init
```

유틸리니 컨테이너의 단점도 존재하는데 터미널의 명령 프롬프트에서 긴 명령들을 실행해야 한다는 것이다.
하지만 Docker Compose 를 사용한다면 해결할 수 있다.

# Docker Compose 사용
```
version: "3.8"
services:
  npm:
    build: ./
    stdin_open: true
    tty: true
    volume: ./:/app
```
```stdin_open``` 와 ```tty``` 플래그를 true 로 설정하여 입력이 필요한 명령의 경우에는 입력을 받을 수 있도록 한다. ```docker run``` 명령의 ```-it``` 옵션과 같은 것이다.

```$ docker run``` 명령의 이미지 뒤에 명령을 추가할 수 있지만 ```$ docker-compose up``` 명령은 단지 docker-compose.yaml 파일에 정의된 서비스를 불러오기 위한 것이다.     
도커 컴포즈에 의해 생성된 이미 실행 중인 컨테이너에서 명령을 실행하기 위해서는 ```$ docker-compose exec``` 과 ```$ docker-compose run``` 을 사용한다.

```$ docker-compose run``` 을 사용하면 yaml 파일에 여러 서비스가 있는 경우 단일 서비스로 실행할 수 있다. 즉, 서비스 이름으로 단일 서비스를 지정할 수 있는 것이다.    
```
$ docker-compose run npm[서비스명] init[명령]
```
```$ docker-compose run``` 에는 up 과 down 이 없으므로 컨테이너가 시작되어 작업을 수행하고 명령이 완료되면 종료된다. 즉, 컨테이너가 제거되지 않는다는 뜻이다.
그렇기에 **--rm 옵션을 추가하면 컨테이너는 명령을 완료한 다음 제거된다.
```
$ docker-compose run --rm npm[서비스명] init[명령]
```

유틸리티 컨테이너 패턴을 유용하다. **먼저 모든 라이브러리, 패키지 등을 설치하지 않고도 로컬 시스템에서 특정한 것을 설정할 수 있음을 의미하기 때문**이다.
